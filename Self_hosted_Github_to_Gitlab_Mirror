name: Mirror to GitLab

on:
  push:
    branches:
      - main

jobs:
  mirror:
    runs-on: self-hosted  # This will run on your server

    steps:
      - name: Checkout the code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITLAB_SSH_KEY }}" > ~/.ssh/github_gitlab_mirror_rsa
          chmod 600 ~/.ssh/github_gitlab_mirror_rsa

          cat <<EOF > ~/.ssh/config
          Host git.rev9solutions.com
            IdentityFile ~/.ssh/github_gitlab_mirror_rsa
            IdentitiesOnly yes
            StrictHostKeyChecking no
          EOF

          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/github_gitlab_mirror_rsa

          ssh-keyscan git.rev9solutions.com >> ~/.ssh/known_hosts

      - name: Push code to GitLab
        run: |
          git config --global user.name "GitHub Mirror Bot"
          git config --global user.email "mirror-bot@example.com"

          # Remove existing remote if it exists
          if git remote | grep -q '^gitlab$'; then
            git remote remove gitlab
          fi

          # Add GitLab remote
          git remote add gitlab URL

          # Push all branches and tags with force
          git push --all --force gitlab
          git push --tags --force gitlab

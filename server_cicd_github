name: Deploy Aviont Marketing Site

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Connect and Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Switching to gitlab-runner..."
            sudo su - gitlab-runner << 'EOF'
            cd /var/www/aviontsite
            echo "Pulling latest code..."
            git pull origin main
            echo "Loading environment..."
            source ~/.bashrc
            echo "Node version:"
            node -v
            npm -v
            echo "Building frontend..."
            cd frontend
            npm install
            npm run build
            echo "Building backend..."
            cd ../backend
            npm install
            npm run build
            echo "Restarting PM2 processes..."
            pm2 restart aivoint-frontend --update-env
            pm2 restart aivoint-backend --update-env
            pm2 save
            EOF
            echo "Deployment completed successfully!"
